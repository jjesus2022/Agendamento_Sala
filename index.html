<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Salas de Reunião - Cerradão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        :root {
            --brand-green: #006837;
            --brand-orange: #D47A2A;
            --brand-light-green: #6DC066;
            --status-pending: #f59e0b;
            --status-approved: #10b981;
            --status-rejected: #ef4444;
        }
        .bg-brand-green { background-color: var(--brand-green); }
        .text-brand-green { color: var(--brand-green); }
        .border-brand-green { border-color: var(--brand-green); }
        .bg-brand-orange { background-color: var(--brand-orange); }
        .text-brand-orange { color: var(--brand-orange); }
        .bg-brand-light-green { background-color: var(--brand-light-green); }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 120px; transition: background-color: 0.2s; }
        .calendar-day:hover { background-color: #f0fdf4; }

        .booking {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            max-width: 90px;
        }

        .booking-sala-01 { background-color: var(--brand-green); }
        .booking-sala-02 { background-color: var(--brand-orange); }
        .booking-sala-03 { background-color: var(--brand-light-green); }
        .booking-pending { opacity: 0.7; border-left: 3px solid var(--status-pending); }
        .booking-approved { border-left: 3px solid var(--status-approved); }
        .booking-rejected { opacity: 0.5; text-decoration: line-through; border-left: 3px solid var(--status-rejected); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        .modal { transition: opacity 0.3s ease; }

        #app {
            display: none;
        }
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.2rem;
            color: #333;
        }

        @media (max-width: 768px) {
            body { -webkit-text-size-adjust: 100%; }
            #calendarDesktopView { display: none; }
            #mobileAgendaView { display: block; }
            #app { padding: 0.5rem; }
            main { grid-template-columns: 1fr; }
            #adminPanel { order: 2; }
            #calendarColumn { order: 1; }
            header { flex-direction: column; gap: 1rem; }
            header h1 { font-size: 1.25rem; order: 1; }
            header .flex.items-center.gap-4:first-child { order: 2; }
            header .flex.items-center.gap-4:last-child { order: 3; flex-direction: column; width: 100%; }
            header .flex.items-center.gap-4:last-child button { width: 100%; margin-top: 0.5rem; }
            .agenda-day { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e2e8f0; }
            .agenda-day-header { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--brand-green); }
            .agenda-day-header .day-of-week { font-weight: 400; color: #4a5568; font-size: 0.875rem; }
            .agenda-booking { display: flex; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; color: white; cursor: pointer; }
            .agenda-booking .time { font-weight: 600; margin-right: 1rem; flex-shrink: 0; }
            .agenda-booking .details { display: flex; flex-direction: column; }
            .agenda-booking .details .title { font-weight: 500; }
            .agenda-booking .details .requester { font-size: 0.75rem; opacity: 0.8; }
            .modal > div { width: 100%; max-width: 100%; height: 100%; max-height: 100%; border-radius: 0; padding: 1.5rem 1rem; overflow-y: auto; }
            #bookingModal .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loader" class="loader-container">
        <p>Carregando sistema de agendamento...</p>
    </div>

    <div id="app" class="min-h-screen p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <img src="logo-cerradao.png" alt="Logo Cerradão" style="height:100px;">
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-brand-green text-center flex-1">Agendamento de Salas de Reunião</h1>
            <div class="flex items-center gap-4">
                <div id="userInfo" class="text-right text-sm"></div>
                <button id="adminLoginBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">Login Admin</button>
                <button id="newBookingBtn" class="bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+ Agendar Sala</button>
            </div>
        </header>
        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <aside id="adminPanel" class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md hidden">
                <h2 class="text-xl font-bold mb-4 text-brand-orange">Painel do Administrador</h2>

                <div id="bulkApproveArea" class="hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Solicitações Pendentes</h3>
                    <div class="mb-2 p-2 border-b">
                        <label class="flex items-center text-sm font-semibold">
                            <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-400 text-brand-green shadow-sm focus:ring-brand-green">
                            <span class="ml-2">Selecionar Todos</span>
                        </label>
                    </div>
                    <div id="pendingRequestsList" class="space-y-2 max-h-80 overflow-y-auto pr-2"></div>
                    <div id="bulkActionsWrapper" class="hidden mt-4 space-y-2">
                        <button id="bulkApproveBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Aprovar Selecionados</button>
                        <button id="bulkRejectBtn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg">Reprovar Selecionados</button>
                    </div>
                </div>
                <div id="noPendingRequestsMessage" class="hidden">
                    <p class="text-sm text-gray-500">Nenhuma solicitação pendente.</p>
                </div>

                <div class="mt-6 border-t pt-4">
                    <button id="exportCsvBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Exportar para CSV</button>
                </div>

                <div id="approvedManagementArea" class="mt-6 border-t pt-4 hidden">
                    <h3 class="text-lg font-bold mb-3 text-gray-700">Gerenciar Aprovados</h3>
                     <div class="mb-2 p-2 border-b">
                        <label class="flex items-center text-sm font-semibold">
                            <input type="checkbox" id="selectAllApprovedCheckbox" class="rounded border-gray-400 text-brand-green shadow-sm focus:ring-brand-green">
                            <span class="ml-2">Selecionar Todos</span>
                        </label>
                    </div>
                    <div id="approvedBookingsList" class="space-y-2 max-h-80 overflow-y-auto pr-2"></div>
                    <div id="approvedActionsWrapper" class="hidden mt-4 space-y-2">
                        <button id="bulkDeleteBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir Selecionados</button>
                    </div>
                     <div id="noApprovedBookingsMessage" class="hidden">
                        <p class="text-sm text-gray-500">Nenhum agendamento aprovado no momento.</p>
                    </div>
                </div>
            </aside>
            <div class="col-span-1 lg:col-span-4" id="calendarColumn">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h2 id="currentMonthYear" class="text-xl font-bold text-center"></h2>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    <div id="calendarDesktopView">
                        <div class="calendar-grid border-t border-l border-gray-200">
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Dom</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Seg</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Ter</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Qua</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Qui</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Sex</div>
                            <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Sáb</div>
                        </div>
                        <div id="calendarBody" class="calendar-grid"></div>
                    </div>
                    <div id="mobileAgendaView" class="hidden"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden pointer-events-none opacity-0">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform scale-95 transition-transform">
            <h2 class="text-2xl font-bold mb-6 text-center">Login do Administrador</h2>
            <form id="loginForm">
                <div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-700">Email</label><input type="email" id="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                <div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-700">Senha</label><input type="password" id="password" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                <div class="flex flex-col gap-2"><button type="submit" class="w-full bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg">Entrar</button><button type="button" id="cancelLoginBtn" class="w-full text-gray-600 hover:text-gray-900 font-medium py-2 px-4">Cancelar</button></div>
            </form>
        </div>
    </div>
    <div id="bookingModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden pointer-events-none opacity-0">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform scale-95 transition-transform">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Novo Agendamento</h2>
            <form id="bookingForm">
                <input type="hidden" id="bookingId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="requesterNameInput" class="block text-sm font-medium text-gray-700">Nome do Solicitante</label><input type="text" id="requesterNameInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label for="requesterEmailInput" class="block text-sm font-medium text-gray-700">E-mail do Solicitante</label><input type="email" id="requesterEmailInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                </div>
                <div class="mb-4"><label for="title" class="block text-sm font-medium text-gray-700">Título da Reunião</label><input type="text" id="title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                <div class="mb-4"><label for="room" class="block text-sm font-medium text-gray-700">Sala</label><select id="room" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required><option value="Sala 01">Sala 01 (Grande - Treinamentos - Automotiva)</option><option value="Sala 02">Sala 02 (Média - Antigo PCM - Automotiva)</option><option value="Sala 03">Sala 03 (Pequena - Frente antigo PCM - Automotiva)</option></select></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div><label for="startDate" class="block text-sm font-medium text-gray-700">Data e Hora de Início</label><input type="datetime-local" id="startDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                    <div><label for="endDate" class="block text-sm font-medium text-gray-700">Data e Hora de Fim</label><input type="datetime-local" id="endDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></div>
                </div>
                <div class="mb-4">
                    <label class="flex items-center"><input type="checkbox" id="isRecurring" class="rounded border-gray-300 text-brand-green shadow-sm"><span class="ml-2 text-sm text-gray-600">Repetir agendamento</span></label>
                </div>
                <div id="recurrenceOptions" class="hidden p-4 bg-gray-50 rounded-lg border border-gray-200 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="recurrenceFrequency" class="block text-sm font-medium text-gray-700">Frequência</label><select id="recurrenceFrequency" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"><option value="daily">Diariamente</option><option value="weekly">Semanalmente</option><option value="monthly">Mensalmente</option></select></div>
                        <div><label for="recurrenceEndDate" class="block text-sm font-medium text-gray-700">Repetir até</label><input type="date" id="recurrenceEndDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></div>
                    </div>
                </div>
                 <div id="requesterInfo" class="mb-4 p-3 bg-gray-100 rounded-md hidden">
                    <p class="text-sm"><span class="font-semibold">Solicitante:</span> <span id="requesterNameDisplay"></span></p>
                    <p class="text-sm"><span class="font-semibold">E-mail:</span> <span id="requesterEmailDisplay"></span></p>
                    <p class="text-sm"><span class="font-semibold">Status:</span> <span id="bookingStatus" class="font-bold"></span></p>
                </div>
                <div class="flex justify-end items-center gap-4 mt-8">
                    <div id="adminActions" class="flex gap-2 hidden">
                         <button type="button" id="approveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Aprovar</button>
                         <button type="button" id="rejectBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Reprovar</button>
                         <button type="button" id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir</button>
                    </div>
                    <button type="button" id="cancelBtn" class="text-gray-600 hover:text-gray-900 font-medium py-2 px-4">Cancelar</button>
                    <button type="submit" id="saveBtn" class="bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        <p id="toastMessage"></p>
    </div>

    <audio id="notificationSound" src="https://freesound.org/data/previews/157/157219_2158733-lq.mp3" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, setPersistence, browserLocalPersistence, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDugzVCdr5fmxnoPVb7SKPzJyBunlN--Kg",
            authDomain: "agendamento-cerradao.firebaseapp.com",
            projectId: "agendamento-cerradao",
            storageBucket: "agendamento-cerradao.appspot.com",
            messagingSenderId: "446686840198",
            appId: "1:446686840198:web:b5193b9a9030321c211807"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ADMIN_EMAIL = 'admin@cerradao.com.br';

        let currentUser = null;
        let isAdmin = false;
        let currentDate = new Date();
        let allBookings = [];
        let unsubscribeFromBookings = null;
        let isInitialLoad = true;

        const elements = {
            loader: document.getElementById('loader'),
            appDiv: document.getElementById('app'),
            userInfo: document.getElementById('userInfo'),
            adminPanel: document.getElementById('adminPanel'),
            calendarColumn: document.getElementById('calendarColumn'),
            calendarBody: document.getElementById('calendarBody'),
            pendingRequestsList: document.getElementById('pendingRequestsList'),
            currentMonthYear: document.getElementById('currentMonthYear'),
            bookingModal: document.getElementById('bookingModal'),
            bookingForm: document.getElementById('bookingForm'),
            modalTitle: document.getElementById('modalTitle'),
            bookingId: document.getElementById('bookingId'),
            title: document.getElementById('title'),
            requesterNameInput: document.getElementById('requesterNameInput'),
            requesterEmailInput: document.getElementById('requesterEmailInput'),
            room: document.getElementById('room'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            requesterInfo: document.getElementById('requesterInfo'),
            requesterNameDisplay: document.getElementById('requesterNameDisplay'),
            requesterEmailDisplay: document.getElementById('requesterEmailDisplay'),
            bookingStatus: document.getElementById('bookingStatus'),
            adminActions: document.getElementById('adminActions'),
            approveBtn: document.getElementById('approveBtn'),
            rejectBtn: document.getElementById('rejectBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            saveBtn: document.getElementById('saveBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            newBookingBtn: document.getElementById('newBookingBtn'),
            prevMonthBtn: document.getElementById('prevMonthBtn'),
            nextMonthBtn: document.getElementById('nextMonthBtn'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            adminLoginBtn: document.getElementById('adminLoginBtn'),
            loginModal: document.getElementById('loginModal'),
            loginForm: document.getElementById('loginForm'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            cancelLoginBtn: document.getElementById('cancelLoginBtn'),
            notificationSound: document.getElementById('notificationSound'),
            isRecurring: document.getElementById('isRecurring'),
            recurrenceOptions: document.getElementById('recurrenceOptions'),
            recurrenceEndDate: document.getElementById('recurrenceEndDate'),
            bulkApproveArea: document.getElementById('bulkApproveArea'),
            noPendingRequestsMessage: document.getElementById('noPendingRequestsMessage'),
            selectAllCheckbox: document.getElementById('selectAllCheckbox'),
            bulkActionsWrapper: document.getElementById('bulkActionsWrapper'),
            bulkApproveBtn: document.getElementById('bulkApproveBtn'),
            bulkRejectBtn: document.getElementById('bulkRejectBtn'),
            // New elements for approved management
            approvedManagementArea: document.getElementById('approvedManagementArea'),
            selectAllApprovedCheckbox: document.getElementById('selectAllApprovedCheckbox'),
            approvedBookingsList: document.getElementById('approvedBookingsList'),
            approvedActionsWrapper: document.getElementById('approvedActionsWrapper'),
            bulkDeleteBtn: document.getElementById('bulkDeleteBtn'),
            noApprovedBookingsMessage: document.getElementById('noApprovedBookingsMessage'),
        };

        // --- FUNÇÕES DE INICIALIZAÇÃO E AUTENTICAÇÃO ---
        async function initializeAppAndAuth() {
            try {
                await setPersistence(auth, browserLocalPersistence);
                onAuthStateChanged(auth, async (user) => {
                    if (unsubscribeFromBookings) unsubscribeFromBookings();
                    currentUser = user;
                    const wasAdmin = isAdmin;
                    isAdmin = user ? !user.isAnonymous && user.email?.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase().trim() : false;
                    if (isAdmin && !wasAdmin && Notification.permission === 'default') {
                        Notification.requestPermission();
                    }
                    if (user) {
                        const bookingsCol = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings');
                        unsubscribeFromBookings = onSnapshot(bookingsCol, (snapshot) => {
                            allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            if (!isInitialLoad && isAdmin) {
                                snapshot.docChanges().forEach((change) => {
                                    if (change.type === "added" && change.doc.data().status === 'pending') {
                                        const newBooking = change.doc.data();
                                        showDesktopNotification('Nova Solicitação de Sala!', `${newBooking.requesterName} solicitou a "${newBooking.room}".`);
                                    }
                                });
                            }
                            renderCalendar();
                            if (isAdmin) {
                                renderPendingRequests();
                                renderApprovedBookings(); // Render approved list
                            }
                            isInitialLoad = false;
                        });
                    } else {
                        await signInAnonymously(auth);
                    }
                    updateUserInfo();
                    setupUIForRole();
                    elements.loader.style.display = 'none';
                    elements.appDiv.style.display = 'block';
                });
            } catch (error) {
                console.error("Erro na inicialização ou persistência:", error);
                elements.loader.innerHTML = `<p class="text-red-500">Erro ao carregar o sistema. Verifique o console.</p>`;
            }
        }

        // --- FUNÇÕES DE UI E HELPERS ---
        function playNotificationSound() {
            elements.notificationSound.currentTime = 0;
            elements.notificationSound.play().catch(error => console.log("A reprodução de áudio foi bloqueada pelo navegador.", error));
        }

        function showDesktopNotification(title, body) {
            if (document.hasFocus()) {
                showToast(body, 'info');
                playNotificationSound();
                return;
            }
            if (!('Notification' in window)) return;
            if (Notification.permission === "granted") {
                new Notification(title, { body, icon: './logo-cerradao.png' });
                playNotificationSound();
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body, icon: './logo-cerradao.png' });
                        playNotificationSound();
                    }
                });
            }
        }

        function updateUserInfo() {
            if (isAdmin) {
                elements.userInfo.innerHTML = `<div><p class="font-semibold">${currentUser.email}</p><button id="logoutBtn" class="text-xs text-red-500 hover:underline">Sair</button></div>`;
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            } else if (currentUser) {
                elements.userInfo.innerHTML = `<p class="font-semibold">Visitante</p><p class="text-xs text-gray-500 truncate" title="${currentUser.uid}">Sessão anônima</p>`;
            } else {
                elements.userInfo.innerHTML = `<p>Autenticando...</p>`;
            }
        }

        function setupUIForRole() {
            const wasAdminPanelHidden = elements.adminPanel.classList.contains('hidden');
            elements.adminPanel.classList.toggle('hidden', !isAdmin);
            elements.calendarColumn.classList.toggle('lg:col-span-3', isAdmin);
            elements.calendarColumn.classList.toggle('lg:col-span-4', !isAdmin);
            elements.adminLoginBtn.classList.toggle('hidden', isAdmin);
            if (isAdmin && wasAdminPanelHidden) {
                renderPendingRequests();
                renderApprovedBookings();
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showToast("Você saiu com sucesso.");
            } catch (error) {
                showToast("Erro ao tentar sair.", "error");
            }
        }

        // --- FUNÇÕES DE RENDERIZAÇÃO ---
        function renderCalendar() {
            const calendarBody = document.getElementById('calendarBody');
            calendarBody.innerHTML = '';
            currentDate.setDate(1);
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();
            elements.currentMonthYear.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarBody.innerHTML += `<div class="calendar-day p-2 border-r border-b bg-gray-50"></div>`;
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day relative p-2 border-r border-b';
                const date = new Date(year, month, day);
                const today = new Date();
                if (date.toDateString() === today.toDateString()) {
                    dayEl.innerHTML = `<div class="absolute top-1 right-1 bg-brand-green text-white rounded-full h-6 w-6 flex items-center justify-center text-sm font-bold">${day}</div>`;
                } else {
                    dayEl.innerHTML = `<div class="text-sm">${day}</div>`;
                }
                const dayBookingsContainer = document.createElement('div');
                dayBookingsContainer.className = 'mt-6 space-y-1';
                const dayBookings = allBookings.filter(b => b.status !== 'rejected' && b.start && b.start.toDate().toDateString() === date.toDateString()).sort((a, b) => a.start.toDate() - b.start.toDate());
                dayBookings.forEach(booking => {
                    const bookingEl = createBookingElement(booking);
                    dayBookingsContainer.appendChild(bookingEl);
                });
                dayEl.appendChild(dayBookingsContainer);
                calendarBody.appendChild(dayEl);
            }
            const mobileAgendaView = document.getElementById('mobileAgendaView');
            mobileAgendaView.innerHTML = '';
            const bookingsThisMonth = allBookings.filter(b => b.status !== 'rejected' && b.start && b.start.toDate().getMonth() === month && b.start.toDate().getFullYear() === year).sort((a, b) => a.start.toDate() - b.start.toDate());
            if (bookingsThisMonth.length === 0) {
                mobileAgendaView.innerHTML = '<p class="text-center text-gray-500 mt-8">Nenhum agendamento para este mês.</p>';
            } else {
                const bookingsByDay = bookingsThisMonth.reduce((acc, booking) => {
                    const dayKey = booking.start.toDate().toDateString();
                    if (!acc[dayKey]) acc[dayKey] = [];
                    acc[dayKey].push(booking);
                    return acc;
                }, {});
                for (const dayKey in bookingsByDay) {
                    const dayBookings = bookingsByDay[dayKey];
                    const date = new Date(dayKey);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'agenda-day';
                    dayEl.innerHTML = `<div class="agenda-day-header">${date.getDate()} de ${date.toLocaleString('pt-BR', { month: 'long' })}<span class="day-of-week">${date.toLocaleString('pt-BR', { weekday: 'long' })}</span></div>`;
                    dayBookings.forEach(booking => {
                        const startTime = booking.start.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const roomClass = `booking-${booking.room.toLowerCase().replace(/\s+/g, '-')}`;
                        dayEl.innerHTML += `<div class="agenda-booking ${roomClass}" data-id="${booking.id}"><div class="time">${startTime}</div><div class="details"><span class="title">${booking.title}</span><span class="requester">${booking.requesterName}</span></div></div>`;
                    });
                    mobileAgendaView.appendChild(dayEl);
                }
                mobileAgendaView.querySelectorAll('.agenda-booking').forEach(el => {
                    el.addEventListener('click', () => {
                        const booking = allBookings.find(b => b.id === el.dataset.id);
                        if (booking) openBookingModal(booking);
                    });
                });
            }
        }

        function createBookingElement(booking) {
            const bookingEl = document.createElement('div');
            const startTime = booking.start.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            bookingEl.className = `booking booking-${booking.room.toLowerCase().replace(/\s+/g, '-')} booking-${booking.status}`;
            bookingEl.textContent = `${startTime} - ${booking.title}`;
            bookingEl.title = `Sala: ${booking.room}\nSolicitante: ${booking.requesterName}\nStatus: ${booking.status}`;
            bookingEl.dataset.id = booking.id;
            bookingEl.addEventListener('click', () => openBookingModal(booking));
            return bookingEl;
        }

        // --- FUNÇÕES DE MODAL E FORMULÁRIOS ---
        function openModal(modal) {
            modal.classList.remove('hidden', 'pointer-events-none');
            modal.classList.add('opacity-100');
            modal.querySelector('div').classList.remove('scale-95');
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden', 'pointer-events-none'), 300);
        }

        function openBookingModal(booking = null) {
            elements.bookingForm.reset();
            elements.bookingId.value = '';
            elements.requesterInfo.classList.add('hidden');
            elements.adminActions.classList.add('hidden');
            elements.saveBtn.classList.remove('hidden');
            elements.recurrenceOptions.classList.add('hidden');
            elements.isRecurring.disabled = false;
            const getStatusColor = (status) => ({ approved: 'green', pending: 'yellow', rejected: 'red' }[status] || 'gray');
            const formatDateTime = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}T${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
            if (booking) {
                elements.modalTitle.textContent = 'Detalhes do Agendamento';
                elements.bookingId.value = booking.id;
                elements.title.value = booking.title;
                elements.requesterNameInput.value = booking.requesterName || '';
                elements.requesterEmailInput.value = booking.requesterEmail || '';
                elements.room.value = booking.room;
                elements.startDate.value = formatDateTime(booking.start.toDate());
                elements.endDate.value = formatDateTime(booking.end.toDate());
                elements.requesterInfo.classList.remove('hidden');
                elements.requesterNameDisplay.textContent = booking.requesterName || 'N/A';
                elements.requesterEmailDisplay.textContent = booking.requesterEmail || 'N/A';
                elements.bookingStatus.textContent = booking.status;
                elements.bookingStatus.className = `font-bold text-${getStatusColor(booking.status)}-500`;
                const canEdit = isAdmin || (currentUser && !currentUser.isAnonymous && currentUser.uid === booking.requesterId && booking.status === 'pending');
                const fields = [elements.title, elements.requesterNameInput, elements.requesterEmailInput, elements.room, elements.startDate, elements.endDate];
                fields.forEach(field => field.disabled = !canEdit);
                elements.saveBtn.classList.toggle('hidden', !canEdit);
                elements.isRecurring.disabled = true;
                if (isAdmin) {
                    elements.adminActions.classList.remove('hidden');
                    elements.approveBtn.classList.toggle('hidden', booking.status !== 'pending');
                    elements.rejectBtn.classList.toggle('hidden', booking.status !== 'pending');
                }
            } else {
                elements.modalTitle.textContent = 'Novo Agendamento';
                const fields = [elements.title, elements.requesterNameInput, elements.requesterEmailInput, elements.room, elements.startDate, elements.endDate];
                fields.forEach(field => field.disabled = false);
                if (isAdmin) {
                    elements.requesterNameInput.value = currentUser.displayName || currentUser.email.split('@')[0];
                    elements.requesterEmailInput.value = currentUser.email;
                }
            }
            openModal(elements.bookingModal);
        }

        // --- EVENT LISTENERS ---
        elements.prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
        elements.nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
        elements.adminLoginBtn.addEventListener('click', () => openModal(elements.loginModal));
        elements.cancelLoginBtn.addEventListener('click', () => closeModal(elements.loginModal));
        elements.newBookingBtn.addEventListener('click', () => openBookingModal());
        elements.cancelBtn.addEventListener('click', () => closeModal(elements.bookingModal));
        elements.isRecurring.addEventListener('change', (e) => {
            elements.recurrenceOptions.classList.toggle('hidden', !e.target.checked);
        });

        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, elements.email.value, elements.password.value);
                closeModal(elements.loginModal);
                showToast("Login de administrador bem-sucedido!");
            } catch (error) {
                showToast("Falha no login. Verifique suas credenciais.", "error");
            }
        });

        elements.bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return showToast("Aguardando autenticação.", "error");

            const id = elements.bookingId.value;
            const start = new Date(elements.startDate.value);
            const end = new Date(elements.endDate.value);

            if (end <= start) return showToast("A data de fim deve ser posterior à de início.", "error");
            if (start.toDateString() !== end.toDateString()) return showToast("O agendamento deve começar e terminar no mesmo dia.", "error");

            const bookingData = { title: elements.title.value, requesterName: elements.requesterNameInput.value, requesterEmail: elements.requesterEmailInput.value, room: elements.room.value, requesterId: currentUser.uid, status: 'pending', createdAt: serverTimestamp() };

            if (elements.isRecurring.checked && !id) {
                const frequency = document.getElementById('recurrenceFrequency').value;
                const recurrenceEndDateValue = elements.recurrenceEndDate.value;
                if (!recurrenceEndDateValue) return showToast("Por favor, selecione a data final da repetição.", "error");
                const recurrenceEndDate = new Date(recurrenceEndDateValue);
                if (recurrenceEndDate < start) return showToast("A data final da repetição deve ser após a data de início.", "error");

                const occurrences = [];
                let currentDate = new Date(start.getTime());
                const eventDuration = end.getTime() - start.getTime();
                while (currentDate <= recurrenceEndDate) {
                    occurrences.push({ start: new Date(currentDate.getTime()), end: new Date(currentDate.getTime() + eventDuration) });
                    if (frequency === 'daily') currentDate.setDate(currentDate.getDate() + 1);
                    else if (frequency === 'weekly') currentDate.setDate(currentDate.getDate() + 7);
                    else if (frequency === 'monthly') currentDate.setMonth(currentDate.getMonth() + 1);
                }

                for (const occ of occurrences) {
                    const hasConflict = allBookings.some(b => b.status === 'approved' && b.room === bookingData.room && Math.max(occ.start, b.start.toDate()) < Math.min(occ.end, b.end.toDate()));
                    if (hasConflict) return showToast(`Conflito de horário no dia ${occ.start.toLocaleDateString()}. Nenhum agendamento foi criado.`, "error");
                }

                try {
                    const batch = writeBatch(db);
                    const bookingsCol = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings');
                    const recurrenceId = doc(collection(db, 'dummy')).id;
                    occurrences.forEach(occ => {
                        batch.set(doc(bookingsCol), { ...bookingData, start: Timestamp.fromDate(occ.start), end: Timestamp.fromDate(occ.end), recurrenceId });
                    });
                    await batch.commit();
                    showToast(`${occurrences.length} agendamentos recorrentes enviados para aprovação!`);
                    closeModal(elements.bookingModal);
                } catch (error) {
                    showToast("Ocorreu um erro ao salvar a série de agendamentos.", "error");
                }
            } else {
                const hasConflict = allBookings.some(b => b.status === 'approved' && b.room === bookingData.room && b.id !== id && Math.max(start, b.start.toDate()) < Math.min(end, b.end.toDate()));
                if (hasConflict) return showToast("Conflito de horário! Já existe uma reserva aprovada.", "error");

                try {
                    const bookingsCol = collection(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings');
                    if (id) {
                        const updateData = { title: bookingData.title, requesterName: bookingData.requesterName, requesterEmail: bookingData.requesterEmail, room: bookingData.room, start: Timestamp.fromDate(start), end: Timestamp.fromDate(end) };
                        await updateDoc(doc(bookingsCol, id), updateData);
                        showToast("Agendamento atualizado!");
                    } else {
                        await addDoc(bookingsCol, { ...bookingData, start: Timestamp.fromDate(start), end: Timestamp.fromDate(end) });
                        showToast("Solicitação de agendamento enviada!");
                    }
                    closeModal(elements.bookingModal);
                } catch (error) {
                    showToast("Ocorreu um erro ao salvar.", "error");
                }
            }
        });

        // --- FUNÇÕES DE ADMINISTRAÇÃO (CRUD e Lote) ---
        const updateBookingStatus = async (id, status) => {
            try {
                await updateDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings', id), { status });
                showToast(`Agendamento ${status === 'approved' ? 'aprovado' : 'reprovado'}!`);
                closeModal(elements.bookingModal);
            } catch (error) {
                showToast("Erro ao atualizar status.", "error");
            }
        };

        const deleteBooking = (id) => {
            if (confirm("Tem certeza que deseja excluir este agendamento?")) {
                deleteDoc(doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings', id))
                    .then(() => { showToast("Agendamento excluído."); closeModal(elements.bookingModal); })
                    .catch(() => showToast("Erro ao excluir.", "error"));
            }
        };

        elements.approveBtn.addEventListener('click', () => updateBookingStatus(elements.bookingId.value, 'approved'));
        elements.rejectBtn.addEventListener('click', () => updateBookingStatus(elements.bookingId.value, 'rejected'));
        elements.deleteBtn.addEventListener('click', () => deleteBooking(elements.bookingId.value));

        function renderPendingRequests() {
            const pending = allBookings.filter(b => b.status === 'pending').sort((a, b) => (a.createdAt?.toDate() || 0) - (b.createdAt?.toDate() || 0));

            elements.bulkApproveArea.classList.toggle('hidden', pending.length === 0);
            elements.noPendingRequestsMessage.classList.toggle('hidden', pending.length > 0);
            elements.bulkActionsWrapper.classList.add('hidden');
            elements.selectAllCheckbox.checked = false;

            if (pending.length > 0) {
                elements.pendingRequestsList.innerHTML = pending.map(booking => {
                    const start = booking.start.toDate();
                    return `<div class="p-2 border rounded-md bg-yellow-50 border-yellow-200 flex items-center gap-2">
                                <input type="checkbox" class="pending-checkbox rounded border-gray-400 text-brand-green shadow-sm" data-id="${booking.id}">
                                <div class="cursor-pointer flex-grow" data-id="${booking.id}">
                                    <p class="font-semibold text-sm">${booking.title}</p>
                                    <p class="text-xs text-gray-600">${booking.room}</p>
                                    <p class="text-xs text-gray-600">${start.toLocaleDateString('pt-BR')} ${start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                            </div>`;
                }).join('');

                elements.pendingRequestsList.querySelectorAll('div[data-id]').forEach(el => {
                    el.addEventListener('click', () => {
                        const booking = allBookings.find(b => b.id === el.dataset.id);
                        if(booking) openBookingModal(booking);
                    });
                });

                const checkBoxes = [...elements.pendingRequestsList.querySelectorAll('.pending-checkbox')];
                checkBoxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const anyChecked = checkBoxes.some(c => c.checked);
                        elements.bulkActionsWrapper.classList.toggle('hidden', !anyChecked);
                    });
                });
            }
        }

        elements.selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            elements.pendingRequestsList.querySelectorAll('.pending-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            elements.bulkActionsWrapper.classList.toggle('hidden', !isChecked || elements.pendingRequestsList.children.length === 0);
        });

        elements.bulkApproveBtn.addEventListener('click', async () => {
            const selectedIds = [...elements.pendingRequestsList.querySelectorAll('.pending-checkbox:checked')].map(c => c.dataset.id);
            if (selectedIds.length === 0) return;

            const bookingsToApprove = allBookings.filter(b => selectedIds.includes(b.id));
            const otherApprovedBookings = allBookings.filter(b => b.status === 'approved' && !selectedIds.includes(b.id));

            for (let i = 0; i < bookingsToApprove.length; i++) {
                const currentBooking = bookingsToApprove[i];
                const start1 = currentBooking.start.toDate();
                const end1 = currentBooking.end.toDate();
                const checkList = [...otherApprovedBookings, ...bookingsToApprove.slice(i + 1)];
                for (const existingBooking of checkList) {
                    if (currentBooking.room === existingBooking.room && Math.max(start1, existingBooking.start.toDate()) < Math.min(end1, existingBooking.end.toDate())) {
                        return showToast(`Conflito: "${currentBooking.title}" choca com "${existingBooking.title}".`, "error");
                    }
                }
            }

            try {
                const batch = writeBatch(db);
                selectedIds.forEach(id => {
                    const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings', id);
                    batch.update(docRef, { status: 'approved' });
                });
                await batch.commit();
                showToast(`${selectedIds.length} agendamentos aprovados com sucesso!`);
            } catch (error) {
                showToast("Erro ao aprovar agendamentos em lote.", "error");
            }
        });

        elements.bulkRejectBtn.addEventListener('click', async () => {
            const selectedIds = [...elements.pendingRequestsList.querySelectorAll('.pending-checkbox:checked')].map(c => c.dataset.id);
            if (selectedIds.length === 0) return;

            if (confirm(`Tem certeza que deseja reprovar os ${selectedIds.length} agendamentos selecionados?`)) {
                try {
                    const batch = writeBatch(db);
                    selectedIds.forEach(id => {
                        const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings', id);
                        batch.update(docRef, { status: 'rejected' });
                    });
                    await batch.commit();
                    showToast(`${selectedIds.length} agendamentos reprovados.`);
                } catch (error) {
                    showToast("Erro ao reprovar agendamentos em lote.", "error");
                }
            }
        });

        function renderApprovedBookings() {
            const approved = allBookings.filter(b => b.status === 'approved').sort((a, b) => (a.start?.toDate() || 0) - (b.start?.toDate() || 0));

            elements.approvedManagementArea.classList.toggle('hidden', approved.length === 0 && !isAdmin);
            elements.noApprovedBookingsMessage.classList.toggle('hidden', approved.length > 0);
            elements.approvedActionsWrapper.classList.add('hidden');
            elements.selectAllApprovedCheckbox.checked = false;

            if (approved.length > 0) {
                elements.approvedBookingsList.innerHTML = approved.map(booking => {
                    const start = booking.start.toDate();
                    return `<div class="p-2 border rounded-md bg-green-50 border-green-200 flex items-center gap-2">
                                <input type="checkbox" class="approved-checkbox rounded border-gray-400 text-brand-green shadow-sm" data-id="${booking.id}">
                                <div class="cursor-pointer flex-grow" data-id="${booking.id}">
                                    <p class="font-semibold text-sm">${booking.title}</p>
                                    <p class="text-xs text-gray-600">${booking.room}</p>
                                    <p class="text-xs text-gray-600">${start.toLocaleDateString('pt-BR')} ${start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                                </div>
                            </div>`;
                }).join('');

                elements.approvedBookingsList.querySelectorAll('div[data-id]').forEach(el => {
                    el.addEventListener('click', () => {
                        const booking = allBookings.find(b => b.id === el.dataset.id);
                        if(booking) openBookingModal(booking);
                    });
                });

                const checkBoxes = [...elements.approvedBookingsList.querySelectorAll('.approved-checkbox')];
                checkBoxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const anyChecked = checkBoxes.some(c => c.checked);
                        elements.approvedActionsWrapper.classList.toggle('hidden', !anyChecked);
                        if (!checkbox.checked) {
                            elements.selectAllApprovedCheckbox.checked = false;
                        } else if (checkBoxes.every(c => c.checked)) {
                            elements.selectAllApprovedCheckbox.checked = true;
                        }
                    });
                });
            } else {
                elements.approvedBookingsList.innerHTML = '';
            }
        }

        elements.selectAllApprovedCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            elements.approvedBookingsList.querySelectorAll('.approved-checkbox').forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            elements.approvedActionsWrapper.classList.toggle('hidden', !isChecked || elements.approvedBookingsList.children.length === 0);
        });

        elements.bulkDeleteBtn.addEventListener('click', async () => {
            const selectedIds = [...elements.approvedBookingsList.querySelectorAll('.approved-checkbox:checked')].map(c => c.dataset.id);
            if (selectedIds.length === 0) return;

            if (confirm(`Tem certeza que deseja EXCLUIR permanentemente os ${selectedIds.length} agendamentos aprovados selecionados? Esta ação não pode ser desfeita.`)) {
                try {
                    const batch = writeBatch(db);
                    selectedIds.forEach(id => {
                        const docRef = doc(db, 'artifacts', firebaseConfig.projectId, 'public', 'data', 'bookings', id);
                        batch.delete(docRef);
                    });
                    await batch.commit();
                    showToast(`${selectedIds.length} agendamentos excluídos com sucesso.`);
                } catch (error) {
                    console.error("Erro ao excluir agendamentos em lote:", error);
                    showToast("Erro ao excluir agendamentos em lote.", "error");
                }
            }
        });

        elements.exportCsvBtn.addEventListener('click', () => {
            const bookingsToExport = allBookings.filter(b => b.status === 'approved');
            if (bookingsToExport.length === 0) return showToast("Nenhum agendamento aprovado para exportar.", "info");
            const headers = ['ID', 'Titulo', 'Sala', 'Inicio', 'Fim', 'SolicitanteNome', 'SolicitanteEmail', 'Status'];
            const rows = bookingsToExport.map(b => [b.id, b.title, b.room, b.start.toDate().toLocaleString('pt-BR'), b.end.toDate().toLocaleString('pt-BR'), b.requesterName, b.requesterEmail, b.status].map(val => `"${String(val).replace(/"/g, '""')}"`).join(','));
            const csvContent = "data:text/csv;charset=utf-8," + [headers.join(','), ...rows].join("\n");
            const link = document.createElement("a");
            link.href = encodeURI(csvContent);
            link.download = `agendamentos_cerradao_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        function showToast(message, type = "success") {
            elements.toastMessage.textContent = message;
            elements.toast.className = 'fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-300';
            const colors = { success: 'bg-gray-800', error: 'bg-red-600', info: 'bg-blue-500' };
            elements.toast.classList.add(colors[type] || 'bg-gray-800', 'opacity-100');
            setTimeout(() => elements.toast.classList.remove('opacity-100'), 5000);
        }

        initializeAppAndAuth();
    </script>
</body>
</html>
