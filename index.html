<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Sala de Reunião</title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5em;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg max-w-4xl w-full space-y-6">
        <div class="flex flex-col items-center">
            <img src="logo-cerradao.png" alt="Logo Cerradão" class="h-20" onerror="this.onerror=null; this.src='https://placehold.co/180x60/cccccc/ffffff?text=Logo';">
            <h1 class="text-3xl font-bold text-center text-gray-800 mt-4">Agendamento de Sala de Reunião</h1>
        </div>
        
        <div id="message-container" class="hidden p-4 rounded-lg text-white font-medium text-center transition-opacity duration-300"></div>
        
        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-gray-50 p-6 rounded-xl border">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Agendar Nova Reunião</h2>
                <form id="appointment-form" class="space-y-4">
                    <select id="room-select" class="w-full p-3 border rounded-lg bg-white" required></select>
                    <input type="date" id="appointment-date" class="w-full p-3 border rounded-lg" required>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="start-time" class="text-sm font-semibold text-gray-600">Início:</label><input type="time" id="start-time" class="w-full p-3 border rounded-lg" required></div>
                        <div><label for="end-time" class="text-sm font-semibold text-gray-600">Fim:</label><input type="time" id="end-time" class="w-full p-3 border rounded-lg" required></div>
                    </div>
                    <input type="text" id="appointment-title" placeholder="Título da Reunião" class="w-full p-3 border rounded-lg" required>
                    <input type="text" id="user-name" placeholder="Seu Nome Completo" class="w-full p-3 border rounded-lg" required>
                    <input type="email" id="user-email" placeholder="Seu E-mail" class="w-full p-3 border rounded-lg" required>
                    <button type="submit" id="submit-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition-all">
                        Solicitar Agendamento
                    </button>
                </form>
            </div>
            
            <div class="bg-gray-50 p-6 rounded-xl border">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Agendamentos para <span id="current-date-display"></span></h2>
                <div class="flex items-center space-x-2 mb-4">
                    <label for="user-role-select" class="text-sm font-semibold text-gray-600">Perfil:</label>
                    <select id="user-role-select" class="p-2 border rounded-lg bg-white"><option value="user">Usuário</option><option value="admin">Admin</option></select>
                </div>
                <div id="admin-password-group" class="hidden flex items-center space-x-2 mb-4">
                    <label for="admin-password" class="text-sm font-semibold text-gray-600">Senha Admin:</label>
                    <input type="password" id="admin-password" class="p-2 border rounded-lg flex-grow">
                    <button id="confirm-admin-password" class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-bold py-2 px-3 rounded-lg">OK</button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <label class="text-sm font-semibold text-gray-600">Ver data:</label>
                    <input type="date" id="view-date-picker" class="p-2 border rounded-lg">
                </div>
                <div id="appointments-list" class="space-y-3 max-h-[420px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // !!! IMPORTANTE: COLOQUE A URL DA SUA API PUBLICADA AQUI !!!
    // Esta URL é gerada quando você implanta seu Google Apps Script como um aplicativo da web.
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjVNIQpAzy3jR3eLw-9ebA_LIHkoyt-GwwyA8BSZJLxh7g0tn9Ov4ZuWRNPHhzjBivSg/exec";

    // !!! A senha do ADMIN agora será verificada SOMENTE no Google Apps Script (backend) !!!
    // Esta variável no frontend é APENAS para o comportamento visual de esconder/mostrar botões.
    // NUNCA coloque senhas sensíveis diretamente no código do frontend em produção.
    const ADMIN_PASSWORD_PLACEHOLDER = 'admin123'; // Use a mesma senha definida no backend para simular o "login" visual.

    const rooms = [
        { name: 'Sala 01 (Grande - Treinamentos)' },
        { name: 'Sala 02 (Média - Antigo PCM)' },
        { name: 'Sala 03 (Pequena - Frente antigo PCM)' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        const dom = {};
        const ids = ['room-select', 'appointment-date', 'start-time', 'end-time', 'appointment-title', 'user-name', 'user-email', 'appointment-form', 'appointments-list', 'message-container', 'view-date-picker', 'current-date-display', 'submit-button', 'user-role-select', 'admin-password-group', 'admin-password', 'confirm-admin-password'];
        ids.forEach(id => { dom[id] = document.getElementById(id); });

        let allAppointments = [];
        let currentUserRole = 'user'; // 'user' ou 'admin' (controlado pelo input de senha simulado)

        // --- FUNÇÕES DE LÓGICA E RENDERIZAÇÃO ---
        
        function showMessage(message, type = 'success', duration = 5000) {
            if (!dom.messageContainer) return;
            dom.messageContainer.textContent = message;
            dom.messageContainer.className = 'p-4 rounded-lg text-white font-medium text-center transition-opacity duration-300';
            dom.messageContainer.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            dom.messageContainer.classList.remove('hidden'); // Garante que a mensagem é visível
            setTimeout(() => { dom.messageContainer.classList.add('hidden'); }, duration);
        }

        function populateRoomSelect() {
            if (!dom.roomSelect) return;
            dom.roomSelect.innerHTML = '<option value="">Selecione a Sala</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.name;
                option.textContent = room.name;
                dom.roomSelect.appendChild(option);
            });
        }

        function renderAppointments(date) {
            if (!dom.currentDateDisplay || !dom.appointmentsList) return;
            dom.currentDateDisplay.textContent = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            const dailyAppointments = allAppointments.filter(a => a.data === date).sort((a,b) => a.inicio.localeCompare(b.inicio));
            
            dom.appointmentsList.innerHTML = '';
            if (dailyAppointments.length === 0) {
                dom.appointmentsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum agendamento para esta data.</p>';
                return;
            }
            dailyAppointments.forEach(appt => {
                const statusClass = appt.status === 'confirmed' ? 'text-green-600' : appt.status === 'Pendente' ? 'text-yellow-600' : 'text-red-500';
                const apptElement = document.createElement('div');
                apptElement.className = 'bg-white p-3 rounded-lg border text-sm space-y-1';
                
                let adminButtons = '';
                if (currentUserRole === 'admin') {
                    if ((appt.status || 'Pendente').toLowerCase() === 'pendente') {
                        adminButtons = `<button class="confirm-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded-full" data-id="${appt.timestamp}">Confirmar</button>
                                        <button class="reject-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-full" data-id="${appt.timestamp}">Recusar</button>`;
                    }
                    adminButtons += `<button class="delete-btn bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded-full ml-auto" data-id="${appt.timestamp}">Excluir</button>`;
                }

                apptElement.innerHTML = `<p class="font-bold text-gray-800">${appt.titulo}</p>
                    <p class="text-gray-600">${appt.sala}</p>
                    <p class="text-gray-600">${appt.inicio} - ${appt.fim}</p>
                    <p class="font-semibold ${statusClass}">${appt.status || 'Pendente'}</p>
                    <p class="text-xs text-gray-400">Por: ${appt.nome}</p>
                    ${adminButtons ? `<div class="flex items-center space-x-2 pt-2">${adminButtons}</div>` : ''}`;
                dom.appointmentsList.appendChild(apptElement);
            });
        }
        
        async function fetchAndRender(date) {
            if (!dom.appointmentsList) return;
            dom.appointmentsList.innerHTML = '<p class="text-gray-500 text-center flex items-center justify-center"><span class="loading-spinner"></span> Carregando...</p>';
            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error('Falha na conexão com a API. Verifique a URL e a publicação do script.');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                allAppointments = data;
                renderAppointments(date);
            } catch(error) { 
                showMessage(error.message, 'error', 10000); // Erros de API ficam mais tempo
                dom.appointmentsList.innerHTML = `<p class="text-red-500 font-semibold text-center">Falha ao carregar dados: ${error.message}</p>`;
            }
        }

        async function postDataAndRefresh(payload) {
            if (!dom.submitButton) return;
            const originalButtonText = dom.submitButton.innerHTML;
            dom.submitButton.disabled = true;
            dom.submitButton.innerHTML = '<span class="loading-spinner"></span> Enviando...'; // Feedback visual

            try {
                // Ao enviar dados para o Google Apps Script, 'text/plain' é recomendado para evitar problemas de CORS
                const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                
                if (!response.ok) throw new Error('Falha ao enviar dados. Verifique a rede ou a URL da API.');
                const result = await response.json(); // O Apps Script retorna JSON

                if (result.status === 'error') { // A API do Apps Script pode retornar 'status: error'
                    throw new Error(result.message || 'Erro desconhecido da API.');
                }
                
                showMessage(result.message || 'Operação realizada com sucesso!', 'success');
                await fetchAndRender(dom.viewDatePicker.value); // Atualiza a lista após a operação
            } catch (error) {
                showMessage(`Erro: ${error.message}`, 'error', 10000); // Mostra o erro retornado pela API
            } finally {
                dom.submitButton.disabled = false;
                dom.submitButton.innerHTML = originalButtonText; // Restaura o texto original do botão
            }
        }

        // --- INICIALIZAÇÃO E EVENTOS ---
        function setupEventListeners() {
            if (dom.appointmentForm) {
                dom.appointmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const startTime = dom.startTime.value;
                    const endTime = dom.endTime.value;

                    // Validação de horário no frontend
                    if (startTime >= endTime) {
                        showMessage('A hora de início deve ser anterior à hora de término.', 'error');
                        return;
                    }

                    const payload = { 
                        action: 'createAppointment', // Indica a ação para o backend
                        roomName: dom.roomSelect.value, 
                        date: dom.appointmentDate.value, 
                        startTime: startTime, 
                        endTime: endTime, 
                        title: dom.appointmentTitle.value, 
                        userName: dom.userName.value, 
                        userEmail: dom.userEmail.value 
                    };
                    await postDataAndRefresh(payload);
                    dom.appointmentForm.reset();
                    // Reseta a data para o dia atual após o agendamento
                    dom.appointmentDate.value = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0]; 
                });
            }

            if (dom.appointmentsList) {
                dom.appointmentsList.addEventListener('click', async (e) => {
                    const button = e.target.closest('button[data-id]');
                    if (!button) return;
                    const id = button.dataset.id;
                    // Use '==' para comparação, pois timestamp do dataset pode ser string e do objeto pode ser number
                    const appt = allAppointments.find(a => a.timestamp == id); 
                    if (!appt) return;

                    let payload;

                    if (button.classList.contains('confirm-btn')) {
                        payload = { 
                            action: 'updateStatus', 
                            appointmentId: id, 
                            newStatus: 'confirmed', 
                            adminPassword: dom.adminPassword.value // Envia a senha para o backend validar
                        };
                    } else if (button.classList.contains('reject-btn')) {
                        payload = { 
                            action: 'updateStatus', 
                            appointmentId: id, 
                            newStatus: 'rejected', 
                            adminPassword: dom.adminPassword.value 
                        };
                    } else if (button.classList.contains('delete-btn')) {
                        if (!confirm('Tem certeza que deseja excluir este agendamento? Esta ação é irreversível.')) return;
                        payload = { 
                            action: 'deleteAppointment', 
                            appointmentId: id, 
                            adminPassword: dom.adminPassword.value 
                        };
                    }

                    if (payload) {
                        // Antes de enviar a ação de admin, verifica se a senha foi digitada no campo.
                        if (!dom.adminPassword.value) {
                            showMessage('Para ações de Admin, por favor, insira a senha de Admin e clique em OK.', 'error', 8000);
                            return;
                        }
                        await postDataAndRefresh(payload);
                    }
                });
            }
            
            // Quando o usuário seleciona uma nova data no seletor de visualização
            if (dom.viewDatePicker) {
                dom.viewDatePicker.addEventListener('change', (e) => fetchAndRender(e.target.value));
            }
            
            // Lógica para alternar entre perfil de Usuário e Admin (somente visual no frontend)
            if (dom.userRoleSelect) {
                dom.userRoleSelect.addEventListener('change', (e) => {
                    const isAdmin = e.target.value === 'admin';
                    if (dom.adminPasswordGroup) dom.adminPasswordGroup.classList.toggle('hidden', !isAdmin);
                    if (isAdmin && dom.adminPassword) dom.adminPassword.focus();
                    else {
                        currentUserRole = 'user'; // Reseta para usuário se não for admin
                        if(dom.userRoleSelect) dom.userRoleSelect.value = 'user'; // Volta a seleção para "Usuário"
                        renderAppointments(dom.viewDatePicker.value); // Re-renderiza para esconder botões de admin
                    }
                });
            }
            
            // Botão para "confirmar" a senha do admin (apenas para habilitar botões no frontend)
            if (dom.confirmAdminPassword) { 
                dom.confirmAdminPassword.addEventListener('click', () => {
                    // Esta validação é APENAS para fins visuais no frontend.
                    // A senha REAL para as ações do Apps Script será enviada em cada payload de admin e verificada no backend.
                    if (dom.adminPassword.value === ADMIN_PASSWORD_PLACEHOLDER) { 
                        currentUserRole = 'admin';
                        showMessage('Modo Administrador ativado (visual).', 'success');
                    } else {
                        currentUserRole = 'user';
                        if(dom.userRoleSelect) dom.userRoleSelect.value = 'user';
                        showMessage('Senha de Admin incorreta (somente visual).', 'error');
                    }
                    if (dom.adminPasswordGroup) dom.adminPasswordGroup.classList.add('hidden'); // Esconde o campo da senha
                    renderAppointments(dom.viewDatePicker.value); // Re-renderiza para mostrar/esconder botões de admin
                });
            }
        }

        function init() {
            // Define a data atual como padrão para os seletores de data
            const today = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0];
            if (dom.appointmentDate) dom.appointmentDate.value = today;
            if (dom.viewDatePicker) dom.viewDatePicker.value = today;
            
            populateRoomSelect(); // Preenche o dropdown de salas
            setupEventListeners(); // Configura todos os ouvintes de eventos
            fetchAndRender(today); // Carrega os agendamentos para o dia atual ao iniciar
        }

        init(); // Chama a função de inicialização
    });
</script>
</body>
</html>
