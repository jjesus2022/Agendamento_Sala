<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Salas de Reunião - Cerradão</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Cores personalizadas baseadas no logo */
        :root {
            --brand-green: #006837;
            --brand-orange: #D47A2A;
            --brand-light-green: #6DC066;
            --status-pending: #f59e0b; /* Ambar */
            --status-approved: #10b981; /* Esmeralda */
            --status-rejected: #ef4444; /* Vermelho */
        }
        .bg-brand-green { background-color: var(--brand-green); }
        .text-brand-green { color: var(--brand-green); }
        .border-brand-green { border-color: var(--brand-green); }
        .bg-brand-orange { background-color: var(--brand-orange); }
        .text-brand-orange { color: var(--brand-orange); }
        .bg-brand-light-green { background-color: var(--brand-light-green); }
        
        /* Estilos para o calendário */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day {
            min-height: 120px;
            transition: background-color: 0.2s;
        }
        .calendar-day:hover {
            background-color: #f0fdf4;
        }
        .booking {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 4px;
            color: white;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }
        /* Cores das salas */
        .booking-sala-01 { background-color: var(--brand-green); }
        .booking-sala-02 { background-color: var(--brand-orange); }
        .booking-sala-03 { background-color: var(--brand-light-green); }

        /* Estilo para status */
        .booking-pending { opacity: 0.7; border-left: 3px solid var(--status-pending); }
        .booking-approved { border-left: 3px solid var(--status-approved); }
        .booking-rejected { opacity: 0.5; text-decoration: line-through; border-left: 3px solid var(--status-rejected); }

        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }

        /* Modal */
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="min-h-screen p-4 md:p-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <div class="flex items-center gap-4 mb-4 md:mb-0">
                <img src="logo-cerradao.png" alt="Logo Cerradão" style="height:100px;">
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-brand-green text-center flex-1">Agendamento de Salas de Reunião</h1>
            <div class="flex items-center gap-4">
                <div id="userInfo" class="text-right text-sm">
                    <p>Carregando...</p>
                </div>
                <button id="adminLoginBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition-colors">
                    Login Admin
                </button>
                <button id="newBookingBtn" class="bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    + Agendar Sala
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <aside id="adminPanel" class="lg:col-span-1 bg-white p-4 rounded-lg shadow-md hidden">
                <h2 class="text-xl font-bold mb-4 text-brand-orange">Painel do Administrador</h2>
                <div id="pendingRequests">
                    <h3 class="font-semibold mb-2">Solicitações Pendentes</h3>
                    <div id="pendingRequestsList" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                        </div>
                </div>
                 <div class="mt-6">
                    <button id="exportCsvBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Exportar para CSV
                    </button>
                </div>
            </aside>

            <div class="col-span-1 lg:col-span-4" id="calendarColumn">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-100">&lt;</button>
                        <h2 id="currentMonthYear" class="text-xl font-bold text-center"></h2>
                        <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-100">&gt;</button>
                    </div>
                    
                    <div class="calendar-grid border-t border-l border-gray-200">
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Dom</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Seg</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Ter</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Qua</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Qui</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Sex</div>
                        <div class="text-center font-bold p-2 border-r border-b bg-gray-50">Sáb</div>
                    </div>
                     <div id="calendarBody" class="calendar-grid"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden pointer-events-none opacity-0">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm p-8 transform scale-95 transition-transform">
            <h2 class="text-2xl font-bold mb-6 text-center">Login do Administrador</h2>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="password" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                </div>
                <div class="flex flex-col gap-2">
                    <button type="submit" class="w-full bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg">Entrar</button>
                    <button type="button" id="cancelLoginBtn" class="w-full text-gray-600 hover:text-gray-900 font-medium py-2 px-4">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="bookingModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 hidden pointer-events-none opacity-0">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-8 transform scale-95 transition-transform">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6">Novo Agendamento</h2>
            <form id="bookingForm">
                <input type="hidden" id="bookingId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="requesterNameInput" class="block text-sm font-medium text-gray-700">Nome do Solicitante</label>
                        <input type="text" id="requesterNameInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                    </div>
                    <div>
                        <label for="requesterEmailInput" class="block text-sm font-medium text-gray-700">E-mail do Solicitante</label>
                        <input type="email" id="requesterEmailInput" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="title" class="block text-sm font-medium text-gray-700">Título da Reunião</label>
                    <input type="text" id="title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                </div>
                <div class="mb-4">
                    <label for="room" class="block text-sm font-medium text-gray-700">Sala</label>
                    <select id="room" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                        <option value="Sala 01">Sala 01 (Grande - Treinamentos)</option>
                        <option value="Sala 02">Sala 02 (Média - Antigo PCM)</option>
                        <option value="Sala 03">Sala 03 (Pequena - Frente antigo PCM)</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Data e Hora de Início</label>
                        <input type="datetime-local" id="startDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">Data e Hora de Fim</label>
                        <input type="datetime-local" id="endDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-green focus:border-brand-green" required>
                    </div>
                </div>
                 <div id="requesterInfo" class="mb-4 p-3 bg-gray-100 rounded-md hidden">
                    <p class="text-sm"><span class="font-semibold">Solicitante:</span> <span id="requesterNameDisplay"></span></p>
                    <p class="text-sm"><span class="font-semibold">E-mail:</span> <span id="requesterEmailDisplay"></span></p>
                    <p class="text-sm"><span class="font-semibold">Status:</span> <span id="bookingStatus" class="font-bold"></span></p>
                </div>
                <div class="flex justify-end items-center gap-4 mt-8">
                    <div id="adminActions" class="flex gap-2 hidden">
                         <button type="button" id="approveBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Aprovar</button>
                         <button type="button" id="rejectBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg">Reprovar</button>
                         <button type="button" id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Excluir</button>
                    </div>
                    <button type="button" id="cancelBtn" class="text-gray-600 hover:text-gray-900 font-medium py-2 px-4">Cancelar</button>
                    <button type="submit" id="saveBtn" class="bg-brand-green hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
        <p id="toastMessage"></p>
    </div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURAÇÃO ---
        // Forçando o uso da configuração fornecida para garantir a conexão com o projeto correto.
        const firebaseConfig = {
            apiKey: "AIzaSyDugzVCdr5fmxnoPVb7SKPzJyBunlN--Kg",
            authDomain: "agendamento-cerradao.firebaseapp.com",
            projectId: "agendamento-cerradao",
            storageBucket: "agendamento-cerradao.appspot.com",
            messagingSenderId: "446686840198",
            appId: "1:446686840198:web:b5193b9a9030321c211807"
        };
        
        // Usando o projectId da configuração para consistência.
        const appId = firebaseConfig.projectId;

        // ** IMPORTANTE: Defina o email do administrador aqui **
        // Este e-mail deve corresponder a um usuário criado no painel de Autenticação do Firebase.
        const ADMIN_EMAIL = 'jjesus@usinacerradao.com.br'; 

        // --- INICIALIZAÇÃO DO FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- ESTADO DA APLICAÇÃO ---
        let currentUser = null;
        let isAdmin = false;
        let currentDate = new Date();
        let allBookings = [];
        let unsubscribeFromBookings = null;

        // --- ELEMENTOS DO DOM ---
        const elements = {
            userInfo: document.getElementById('userInfo'),
            adminPanel: document.getElementById('adminPanel'),
            calendarColumn: document.getElementById('calendarColumn'),
            pendingRequestsList: document.getElementById('pendingRequestsList'),
            currentMonthYear: document.getElementById('currentMonthYear'),
            calendarBody: document.getElementById('calendarBody'),
            bookingModal: document.getElementById('bookingModal'),
            bookingForm: document.getElementById('bookingForm'),
            modalTitle: document.getElementById('modalTitle'),
            bookingId: document.getElementById('bookingId'),
            title: document.getElementById('title'),
            requesterNameInput: document.getElementById('requesterNameInput'),
            requesterEmailInput: document.getElementById('requesterEmailInput'),
            room: document.getElementById('room'),
            startDate: document.getElementById('startDate'),
            endDate: document.getElementById('endDate'),
            requesterInfo: document.getElementById('requesterInfo'),
            requesterNameDisplay: document.getElementById('requesterNameDisplay'),
            requesterEmailDisplay: document.getElementById('requesterEmailDisplay'),
            bookingStatus: document.getElementById('bookingStatus'),
            adminActions: document.getElementById('adminActions'),
            approveBtn: document.getElementById('approveBtn'),
            rejectBtn: document.getElementById('rejectBtn'),
            deleteBtn: document.getElementById('deleteBtn'),
            saveBtn: document.getElementById('saveBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            newBookingBtn: document.getElementById('newBookingBtn'),
            prevMonthBtn: document.getElementById('prevMonthBtn'),
            nextMonthBtn: document.getElementById('nextMonthBtn'),
            exportCsvBtn: document.getElementById('exportCsvBtn'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            // Login
            adminLoginBtn: document.getElementById('adminLoginBtn'),
            loginModal: document.getElementById('loginModal'),
            loginForm: document.getElementById('loginForm'),
            email: document.getElementById('email'),
            password: document.getElementById('password'),
            cancelLoginBtn: document.getElementById('cancelLoginBtn'),
        };

        // --- AUTENTICAÇÃO E INICIALIZAÇÃO DA APLICAÇÃO ---
        async function initializeAppAndAuth() {
            onAuthStateChanged(auth, (user) => {
                if (unsubscribeFromBookings) {
                    unsubscribeFromBookings();
                    unsubscribeFromBookings = null;
                }

                currentUser = user;
                isAdmin = user ? !user.isAnonymous && user.email?.toLowerCase().trim() === ADMIN_EMAIL.toLowerCase().trim() : false;

                if (user) {
                    const bookingsCol = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
                    unsubscribeFromBookings = onSnapshot(bookingsCol, (snapshot) => {
                        allBookings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderCalendar();
                        if (isAdmin) {
                            renderPendingRequests();
                        }
                    }, (error) => {
                        console.error("Erro no listener do Firestore:", error);
                        elements.calendarBody.innerHTML = `<p class="text-red-500 p-4">Erro ao carregar agendamentos. Verifique as permissões do banco de dados.</p>`;
                    });
                }
                
                updateUserInfo();
                setupUIForRole();
            });

            try {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação inicial:", error);
                elements.userInfo.innerHTML = `<p class="text-red-500">Falha na autenticação inicial.</p>`;
            }
        }
        
        function updateUserInfo() {
            if (isAdmin) {
                elements.userInfo.innerHTML = `
                    <div>
                        <p class="font-semibold">${currentUser.email}</p>
                        <button id="logoutBtn" class="text-xs text-red-500 hover:underline">Sair</button>
                    </div>
                `;
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            } else if (currentUser) {
                 elements.userInfo.innerHTML = `
                    <p class="font-semibold">Visitante</p>
                    <p class="text-xs text-gray-500 truncate" title="${currentUser.uid}">Sessão anônima</p>
                `;
            } else {
                elements.userInfo.innerHTML = `<p>Autenticando...</p>`;
            }
        }

        function setupUIForRole() {
            if (isAdmin) {
                elements.adminPanel.classList.remove('hidden');
                elements.calendarColumn.classList.remove('lg:col-span-4');
                elements.calendarColumn.classList.add('lg:col-span-3');
                elements.adminLoginBtn.classList.add('hidden');
            } else {
                elements.adminPanel.classList.add('hidden');
                elements.calendarColumn.classList.remove('lg:col-span-3');
                elements.calendarColumn.classList.add('lg:col-span-4');
                elements.adminLoginBtn.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                showToast("Você saiu com sucesso.");
            } catch (error) {
                console.error("Erro ao sair:", error);
                showToast("Erro ao tentar sair.", "error");
            }
        }
        
        // --- LÓGICA DO CALENDÁRIO ---
        function renderCalendar() {
            elements.calendarBody.innerHTML = '';
            currentDate.setDate(1);
            const month = currentDate.getMonth();
            const year = currentDate.getFullYear();

            elements.currentMonthYear.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} de ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDayOfMonth; i++) {
                elements.calendarBody.innerHTML += `<div class="calendar-day p-2 border-r border-b bg-gray-50"></div>`;
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day relative p-2 border-r border-b';
                
                const date = new Date(year, month, day);
                if (isToday(date)) {
                    dayEl.innerHTML = `<div class="absolute top-1 right-1 bg-brand-green text-white rounded-full h-6 w-6 flex items-center justify-center text-sm font-bold">${day}</div>`;
                } else {
                    dayEl.innerHTML = `<div class="text-sm">${day}</div>`;
                }
                
                const dayBookingsContainer = document.createElement('div');
                dayBookingsContainer.className = 'mt-6 space-y-1';
                
                const dayBookings = getBookingsForDay(date);
                dayBookings.forEach(booking => {
                    const bookingEl = createBookingElement(booking);
                    dayBookingsContainer.appendChild(bookingEl);
                });

                dayEl.appendChild(dayBookingsContainer);
                elements.calendarBody.appendChild(dayEl);
            }
        }

        function getBookingsForDay(date) {
            return allBookings
                .filter(b => b.status !== 'rejected')
                .filter(b => {
                    if (!b.start) return false;
                    const start = b.start.toDate();
                    return start.getFullYear() === date.getFullYear() &&
                           start.getMonth() === date.getMonth() &&
                           start.getDate() === date.getDate();
                })
                .sort((a, b) => a.start.toDate() - b.start.toDate());
        }

        function createBookingElement(booking) {
            const bookingEl = document.createElement('div');
            const startTime = booking.start.toDate().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            bookingEl.className = `booking booking-${booking.room.toLowerCase().replace(/\s+/g, '-')} booking-${booking.status}`;
            bookingEl.textContent = `${startTime} - ${booking.title}`;
            bookingEl.title = `Sala: ${booking.room}\nSolicitante: ${booking.requesterName}\nStatus: ${booking.status}`;
            bookingEl.dataset.id = booking.id;
            bookingEl.addEventListener('click', () => openBookingModal(booking));
            return bookingEl;
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }

        elements.prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        elements.nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // --- LÓGICA DOS MODAIS ---
        function openModal(modal) {
            modal.classList.remove('hidden', 'pointer-events-none');
            modal.classList.add('opacity-100');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');
        }

        function closeModal(modal) {
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden', 'pointer-events-none');
            }, 300);
        }

        // Modal de Login
        elements.adminLoginBtn.addEventListener('click', () => openModal(elements.loginModal));
        elements.cancelLoginBtn.addEventListener('click', () => closeModal(elements.loginModal));
        elements.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = elements.email.value;
            const password = elements.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal(elements.loginModal);
                showToast("Login de administrador bem-sucedido!");
            } catch (error) {
                console.error("Erro de login:", error.code);
                if (error.code === 'auth/operation-not-allowed') {
                    showToast("Erro: Login por e-mail desabilitado no Firebase.", "error");
                } else {
                    showToast("Falha no login. Verifique suas credenciais.", "error");
                }
            }
        });

        // Modal de Agendamento
        function openBookingModal(booking = null) {
            elements.bookingForm.reset();
            elements.bookingId.value = '';
            elements.requesterInfo.classList.add('hidden');
            elements.adminActions.classList.add('hidden');
            elements.saveBtn.classList.remove('hidden');

            if (booking) {
                elements.modalTitle.textContent = 'Detalhes do Agendamento';
                elements.bookingId.value = booking.id;
                elements.title.value = booking.title;
                elements.requesterNameInput.value = booking.requesterName || '';
                elements.requesterEmailInput.value = booking.requesterEmail || '';
                elements.room.value = booking.room;
                elements.startDate.value = formatDateTimeForInput(booking.start.toDate());
                elements.endDate.value = formatDateTimeForInput(booking.end.toDate());
                
                elements.requesterInfo.classList.remove('hidden');
                elements.requesterNameDisplay.textContent = booking.requesterName || 'N/A';
                elements.requesterEmailDisplay.textContent = booking.requesterEmail || 'N/A';
                elements.bookingStatus.textContent = booking.status;
                elements.bookingStatus.className = `font-bold text-${getStatusColor(booking.status)}-500`;

                const canEdit = currentUser && !currentUser.isAnonymous && currentUser.uid === booking.requesterId && booking.status === 'pending';
                
                elements.title.disabled = !canEdit && !isAdmin;
                elements.requesterNameInput.disabled = !canEdit && !isAdmin;
                elements.requesterEmailInput.disabled = !canEdit && !isAdmin;
                elements.room.disabled = !canEdit && !isAdmin;
                elements.startDate.disabled = !canEdit && !isAdmin;
                elements.endDate.disabled = !canEdit && !isAdmin;
                elements.saveBtn.classList.toggle('hidden', !canEdit && !isAdmin);

                if (isAdmin) {
                    elements.adminActions.classList.remove('hidden');
                    elements.approveBtn.classList.toggle('hidden', booking.status !== 'pending');
                    elements.rejectBtn.classList.toggle('hidden', booking.status !== 'pending');
                }

            } else {
                elements.modalTitle.textContent = 'Novo Agendamento';
                elements.title.disabled = false;
                elements.requesterNameInput.disabled = false;
                elements.requesterEmailInput.disabled = false;
                elements.room.disabled = false;
                elements.startDate.disabled = false;
                elements.endDate.disabled = false;

                // Preenche automaticamente se for admin
                if (isAdmin) {
                    elements.requesterNameInput.value = currentUser.displayName || currentUser.email.split('@')[0];
                    elements.requesterEmailInput.value = currentUser.email;
                }
            }

            openModal(elements.bookingModal);
        }

        function closeBookingModal() {
            closeModal(elements.bookingModal);
        }

        function formatDateTimeForInput(date) {
            const pad = (num) => num.toString().padStart(2, '0');
            return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
        }
        
        function getStatusColor(status) {
            switch(status) {
                case 'approved': return 'green';
                case 'pending': return 'yellow';
                case 'rejected': return 'red';
                default: return 'gray';
            }
        }

        elements.newBookingBtn.addEventListener('click', () => {
            openBookingModal();
        });
        elements.cancelBtn.addEventListener('click', closeBookingModal);

        // --- OPERAÇÕES NO FIREBASE (CRUD) ---
        elements.bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showToast("Aguardando autenticação. Tente novamente.", "error");
                return;
            }
            const id = elements.bookingId.value;
            const start = new Date(elements.startDate.value);
            const end = new Date(elements.endDate.value);

            // Validação para garantir que a data de fim seja posterior à de início
            if (end <= start) {
                showToast("A data de fim deve ser posterior à data de início.", "error");
                return;
            }
            
            // REGRA ADICIONADA: Bloqueia agendamentos que duram mais de um dia
            if (start.toDateString() !== end.toDateString()) {
                showToast("O agendamento deve começar e terminar no mesmo dia.", "error");
                return;
            }

            // Validação de conflito de horário
            if (hasConflict(start, end, elements.room.value, id)) {
                showToast("Conflito de horário! Já existe uma reserva aprovada para esta sala neste período.", "error");
                return;
            }

            const bookingData = {
                title: elements.title.value,
                requesterName: elements.requesterNameInput.value,
                requesterEmail: elements.requesterEmailInput.value,
                room: elements.room.value,
                start: Timestamp.fromDate(start),
                end: Timestamp.fromDate(end),
            };
            
            try {
                const bookingsCol = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
                if (id) {
                    const docRef = doc(db, bookingsCol.path, id);
                    await updateDoc(docRef, bookingData);
                    showToast("Agendamento atualizado com sucesso!");
                } else {
                    bookingData.requesterId = currentUser.uid;
                    bookingData.status = 'pending';
                    bookingData.createdAt = serverTimestamp();
                    await addDoc(bookingsCol, bookingData);
                    showToast("Solicitação de agendamento enviada!");
                }
                closeBookingModal();
            } catch (error) {
                console.error("Erro ao salvar agendamento:", error);
                showToast("Ocorreu um erro ao salvar.", "error");
            }
        });
        
        function hasConflict(start, end, room, currentBookingId) {
            const approvedBookings = allBookings.filter(b => 
                b.status === 'approved' && 
                b.room === room && 
                b.id !== currentBookingId
            );

            for (const booking of approvedBookings) {
                const bookingStart = booking.start.toDate();
                const bookingEnd = booking.end.toDate();
                if (Math.max(start, bookingStart) < Math.min(end, bookingEnd)) {
                    return true;
                }
            }
            return false;
        }

        async function updateBookingStatus(id, status) {
            const bookingsCol = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
            const docRef = doc(db, bookingsCol.path, id);
            try {
                await updateDoc(docRef, { status });
                showToast(`Agendamento ${status === 'approved' ? 'aprovado' : 'reprovado'}!`);
                closeBookingModal();
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                showToast("Erro ao atualizar status.", "error");
            }
        }
        
        async function deleteBooking(id) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl">
                    <p class="mb-4">Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita.</p>
                    <div class="flex justify-end gap-4">
                        <button id="confirmDelete" class="bg-red-600 text-white px-4 py-2 rounded-lg">Sim, Excluir</button>
                        <button id="cancelDelete" class="bg-gray-200 px-4 py-2 rounded-lg">Cancelar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirmDelete').onclick = async () => {
                const bookingsCol = collection(db, 'artifacts', appId, 'public', 'data', 'bookings');
                const docRef = doc(db, bookingsCol.path, id);
                try {
                    await deleteDoc(docRef);
                    showToast("Agendamento excluído com sucesso.");
                    closeBookingModal();
                } catch (error) {
                    console.error("Erro ao excluir agendamento:", error);
                    showToast("Erro ao excluir.", "error");
                } finally {
                     document.body.removeChild(modal);
                }
            };
            document.getElementById('cancelDelete').onclick = () => {
                document.body.removeChild(modal);
            };
        }

        elements.approveBtn.addEventListener('click', () => {
            const id = elements.bookingId.value;
            const start = new Date(elements.startDate.value);
            const end = new Date(elements.endDate.value);
            const room = elements.room.value;
            if (hasConflict(start, end, room, id)) {
                showToast("Conflito de horário! Não é possível aprovar.", "error");
                return;
            }
            updateBookingStatus(id, 'approved');
        });
        elements.rejectBtn.addEventListener('click', () => updateBookingStatus(elements.bookingId.value, 'rejected'));
        elements.deleteBtn.addEventListener('click', () => deleteBooking(elements.bookingId.value));

        // --- PAINEL DO ADMINISTRADOR ---
        function renderPendingRequests() {
            const pending = allBookings
                .filter(b => b.status === 'pending')
                .sort((a, b) => {
                    if (!a.createdAt || !b.createdAt) return 0;
                    return a.createdAt.toDate() - b.createdAt.toDate()
                });
            
            elements.pendingRequestsList.innerHTML = '';
            if (pending.length === 0) {
                elements.pendingRequestsList.innerHTML = '<p class="text-sm text-gray-500">Nenhuma solicitação pendente.</p>';
                return;
            }
            
            pending.forEach(booking => {
                const reqEl = document.createElement('div');
                reqEl.className = 'p-3 border rounded-md bg-yellow-50 border-yellow-200 cursor-pointer hover:bg-yellow-100';
                reqEl.addEventListener('click', () => openBookingModal(booking));
                
                const start = booking.start.toDate();
                reqEl.innerHTML = `
                    <p class="font-semibold text-sm">${booking.title}</p>
                    <p class="text-xs text-gray-600">${booking.room}</p>
                    <p class="text-xs text-gray-600">${start.toLocaleDateString('pt-BR')} ${start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>
                `;
                elements.pendingRequestsList.appendChild(reqEl);
            });
        }
        
        // --- EXPORTAR PARA CSV ---
        elements.exportCsvBtn.addEventListener('click', () => {
            const bookingsToExport = allBookings.filter(b => b.status === 'approved');
            if (bookingsToExport.length === 0) {
                showToast("Nenhum agendamento aprovado para exportar.", "info");
                return;
            }

            const headers = ['ID', 'Titulo', 'Sala', 'Inicio', 'Fim', 'SolicitanteNome', 'SolicitanteEmail', 'Status'];
            const rows = bookingsToExport.map(b => [
                `"${b.id}"`,
                `"${b.title}"`,
                `"${b.room}"`,
                `"${b.start.toDate().toLocaleString('pt-BR')}"`,
                `"${b.end.toDate().toLocaleString('pt-BR')}"`,
                `"${b.requesterName}"`,
                `"${b.requesterEmail}"`,
                `"${b.status}"`
            ]);

            let csvContent = "data:text/csv;charset=utf-8," 
                + headers.join(",") + "\n" 
                + rows.map(e => e.join(",")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `agendamentos_cerradao_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // --- UTILITÁRIOS ---
        function showToast(message, type = "success") {
            elements.toastMessage.textContent = message;
            elements.toast.classList.remove('bg-gray-800', 'bg-red-600', 'bg-blue-500');
            switch(type) {
                case 'error': elements.toast.classList.add('bg-red-600'); break;
                case 'info': elements.toast.classList.add('bg-blue-500'); break;
                default: elements.toast.classList.add('bg-gray-800'); break;
            }
            elements.toast.classList.add('opacity-100');
            setTimeout(() => {
                elements.toast.classList.remove('opacity-100');
            }, 3000);
        }

        // --- INICIALIZAÇÃO DA APLICAÇÃO ---
        initializeAppAndAuth();
        renderCalendar(); // Renderização inicial com dados vazios

    </script>
</body>
</html>
