<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Sala de Reunião</title>
    
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .loading-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 1em;
            height: 1em;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5em;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos para o modal de confirmação */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        .modal-buttons button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-buttons .confirm-button {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .modal-buttons .confirm-button:hover {
            background-color: #dc2626; /* red-600 */
        }
        .modal-buttons .cancel-button {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
        }
        .modal-buttons .cancel-button:hover {
            background-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg max-w-4xl w-full space-y-6">
        <div class="flex flex-col items-center">
            <img src="logo-cerradao.png" alt="Logo Cerradão" class="h-20" onerror="this.onerror=null; this.src='https://placehold.co/180x60/cccccc/ffffff?text=Logo';">
            <h1 class="text-3xl font-bold text-center text-gray-800 mt-4">Agendamento de Sala de Reunião</h1>
        </div>
        
        <div id="message-container" class="hidden p-4 rounded-lg text-white font-medium text-center transition-opacity duration-300"></div>
        
        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-gray-50 p-6 rounded-xl border">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Agendar Nova Reunião</h2>
                <form id="appointment-form" class="space-y-4">
                    <select id="room-select" class="w-full p-3 border rounded-lg bg-white" required></select>
                    <input type="date" id="appointment-date" class="w-full p-3 border rounded-lg" required>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="start-time" class="text-sm font-semibold text-gray-600">Início:</label><input type="time" id="start-time" class="w-full p-3 border rounded-lg" required></div>
                        <div><label for="end-time" class="text-sm font-semibold text-gray-600">Fim:</label><input type="time" id="end-time" class="w-full p-3 border rounded-lg" required></div>
                    </div>
                    <input type="text" id="appointment-title" placeholder="Título da Reunião" class="w-full p-3 border rounded-lg" required>
                    <input type="text" id="user-name" placeholder="Seu Nome Completo" class="w-full p-3 border rounded-lg" required>
                    <input type="email" id="user-email" placeholder="Seu E-mail" class="w-full p-3 border rounded-lg" required>
                    <button type="submit" id="submit-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-md transition-all">
                        Solicitar Agendamento
                    </button>
                </form>
            </div>
            
            <div class="bg-gray-50 p-6 rounded-xl border">
                <h2 class="text-2xl font-bold text-gray-700 mb-6">Agendamentos para <span id="current-date-display"></span></h2>
                <div class="flex items-center space-x-2 mb-4">
                    <label for="user-role-select" class="text-sm font-semibold text-gray-600">Perfil:</label>
                    <select id="user-role-select" class="p-2 border rounded-lg bg-white"><option value="user">Usuário</option><option value="admin">Admin</option></select>
                </div>
                <div id="admin-password-group" class="hidden flex items-center space-x-2 mb-4">
                    <label for="admin-password" class="text-sm font-semibold text-gray-600">Senha Admin:</label>
                    <input type="password" id="admin-password" class="p-2 border rounded-lg flex-grow">
                    <button id="confirm-admin-password" class="bg-gray-700 hover:bg-gray-800 text-white text-xs font-bold py-2 px-3 rounded-lg">OK</button>
                </div>
                <div class="flex items-center space-x-2 mb-4">
                    <label class="text-sm font-semibold text-gray-600">Ver data:</label>
                    <input type="date" id="view-date-picker" class="p-2 border rounded-lg">
                </div>
                <div id="appointments-list" class="space-y-3 max-h-[420px] overflow-y-auto pr-2">
                    <p class="text-gray-500 text-center">Carregando...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-confirm-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <p id="modal-message" class="text-lg text-gray-800 mb-4"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-button" class="confirm-button">Confirmar</button>
                <button id="modal-cancel-button" class="cancel-button">Cancelar</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuração do seu projeto Firebase. SUBSTITUA PELOS SEUS DADOS!
        const firebaseConfig = {
            apiKey: "AIzaSyDFk1-zfqVr6-2gkXtYI4Ghkxjjj-VjIsw0", // Substitua pelo seu apiKey
            authDomain: "agendamentos-cafc1.firebaseapp.com", // Substitua pelo seu authDomain
            projectId: "agendamentos-cafc1", // Substitua pelo seu projectId
            storageBucket: "agendamentos-cafc1.firebasestorage.app", // Substitua pelo seu storageBucket
            messagingSenderId: "892824959903", // Substitua pelo seu messagingSenderId
            appId: "1:892824959903:web:85f0c9698922910390dbaa", // Substitua pelo seu appId
            measurementId: "G-Z2V7VCN390" // Substitua pelo seu measurementId (opcional)
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Obtém a instância do Firestore

        // --- VARIÁVEIS GLOBAIS E ELEMENTOS DO DOM ---
        const rooms = [
            { name: 'Sala 01 (Grande - Treinamentos)' },
            { name: 'Sala 02 (Média - Antigo PCM)' },
            { name: 'Sala 03 (Pequena - Frente antigo PCM)' }
        ];

        const dom = {};
        const ids = ['room-select', 'appointment-date', 'start-time', 'end-time', 'appointment-title', 'user-name', 'user-email', 'appointment-form', 'appointments-list', 'message-container', 'view-date-picker', 'current-date-display', 'submit-button', 'user-role-select', 'admin-password-group', 'admin-password', 'confirm-admin-password', 'custom-confirm-modal', 'modal-message', 'modal-confirm-button', 'modal-cancel-button'];
        ids.forEach(id => { dom[id] = document.getElementById(id); });

        let allAppointments = [];
        let currentUserRole = 'user'; // 'user' ou 'admin' (controlado pelo input de senha simulado)

        // ATENÇÃO: Esta senha é APENAS para o comportamento visual do frontend.
        // A segurança real (para quem pode confirmar/deletar) deve ser feita com Firebase Security Rules e/ou Cloud Functions.
        const ADMIN_PASSWORD_PLACEHOLDER = 'admin123'; 

        // --- FUNÇÃO PARA MODAL DE CONFIRMAÇÃO PERSONALIZADO ---
        function customConfirm(message) {
            return new Promise((resolve) => {
                if (!dom.customConfirmModal || !dom.modalMessage || !dom.modalConfirmButton || !dom.modalCancelButton) {
                    console.error("Elementos do modal não encontrados.");
                    resolve(window.confirm(message)); // Fallback para confirm nativo
                    return;
                }

                dom.modalMessage.textContent = message;
                dom.customConfirmModal.classList.remove('hidden');

                const confirmHandler = () => {
                    dom.customConfirmModal.classList.add('hidden');
                    dom.modalConfirmButton.removeEventListener('click', confirmHandler);
                    dom.modalCancelButton.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    dom.customConfirmModal.classList.add('hidden');
                    dom.modalConfirmButton.removeEventListener('click', confirmHandler);
                    dom.modalCancelButton.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                dom.modalConfirmButton.addEventListener('click', confirmHandler);
                dom.modalCancelButton.addEventListener('click', cancelHandler);
            });
        }

        // --- FUNÇÕES DE LÓGICA E RENDERIZAÇÃO ---
        function showMessage(message, type = 'success', duration = 5000) {
            if (!dom.messageContainer) return;
            dom.messageContainer.textContent = message;
            dom.messageContainer.className = 'p-4 rounded-lg text-white font-medium text-center transition-opacity duration-300';
            dom.messageContainer.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500');
            dom.messageContainer.classList.remove('hidden');
            setTimeout(() => { dom.messageContainer.classList.add('hidden'); }, duration);
        }

        function populateRoomSelect() {
            if (!dom.roomSelect) return;
            dom.roomSelect.innerHTML = '<option value="">Selecione a Sala</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.name;
                option.textContent = room.name;
                dom.roomSelect.appendChild(option);
            });
        }

        function renderAppointments(date) {
            if (!dom.currentDateDisplay || !dom.appointmentsList) return;
            dom.currentDateDisplay.textContent = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            // Filtra e ordena os agendamentos para a data selecionada
            const dailyAppointments = allAppointments
                .filter(a => a.data === date)
                .sort((a,b) => a.inicio.localeCompare(b.inicio));
            
            dom.appointmentsList.innerHTML = '';
            if (dailyAppointments.length === 0) {
                dom.appointmentsList.innerHTML = '<p class="text-gray-500 text-center">Nenhum agendamento para esta data.</p>';
                return;
            }
            dailyAppointments.forEach(appt => {
                const statusClass = appt.status === 'confirmed' ? 'text-green-600' : appt.status === 'Pendente' ? 'text-yellow-600' : 'text-red-500';
                const apptElement = document.createElement('div');
                apptElement.className = 'bg-white p-3 rounded-lg border text-sm space-y-1';
                
                let adminButtons = '';
                // Mostra botões de admin apenas se o modo admin estiver ativado no frontend
                if (currentUserRole === 'admin') {
                    if ((appt.status || 'Pendente').toLowerCase() === 'pendente') {
                        adminButtons = `<button class="confirm-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-2 rounded-full" data-id="${appt.id}">Confirmar</button>
                                        <button class="reject-btn bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-2 rounded-full" data-id="${appt.id}">Recusar</button>`;
                    }
                    adminButtons += `<button class="delete-btn bg-gray-500 hover:bg-gray-600 text-white text-xs font-bold py-1 px-2 rounded-full ml-auto" data-id="${appt.id}">Excluir</button>`;
                }

                apptElement.innerHTML = `<p class="font-bold text-gray-800">${appt.titulo}</p>
                    <p class="text-gray-600">${appt.sala}</p>
                    <p class="text-gray-600">${appt.inicio} - ${appt.fim}</p>
                    <p class="font-semibold ${statusClass}">${appt.status || 'Pendente'}</p>
                    <p class="text-xs text-gray-400">Por: ${appt.nome}</p>
                    ${adminButtons ? `<div class="flex items-center space-x-2 pt-2">${adminButtons}</div>` : ''}`;
                dom.appointmentsList.appendChild(apptElement);
            });
        }
        
        // Função para buscar e renderizar agendamentos do Firestore
        async function fetchAndRenderAppointments(date) {
            if (!dom.appointmentsList) return;
            dom.appointmentsList.innerHTML = '<p class="text-gray-500 text-center flex items-center justify-center"><span class="loading-spinner"></span> Carregando...</p>';
            try {
                // Obtém todos os agendamentos para a data selecionada na coleção 'agendamentos'
                const appointmentsRef = db.collection('agendamentos');
                const querySnapshot = await appointmentsRef.where('data', '==', date).get();
                
                allAppointments = querySnapshot.docs.map(doc => ({
                    id: doc.id, // O ID único do documento no Firestore
                    ...doc.data() // Todos os outros campos do documento
                }));
                
                renderAppointments(date);
            } catch(error) { 
                showMessage(`Erro ao carregar agendamentos: ${error.message}`, 'error', 10000);
                dom.appointmentsList.innerHTML = `<p class="text-red-500 font-semibold text-center">Falha ao carregar dados: ${error.message}</p>`;
            }
        }

        // Função para criar um novo agendamento no Firestore
        async function createAppointmentInFirestore(payload) {
            if (!dom.submitButton) return;
            const originalButtonText = dom.submitButton.innerHTML;
            dom.submitButton.disabled = true;
            dom.submitButton.innerHTML = '<span class="loading-spinner"></span> Enviando...';

            try {
                // Validação de conflito de horário (frontend).
                // Para uma validação mais robusta e segura (especialmente em ambientes multiusuário),
                // considere implementar essa lógica em uma Firebase Cloud Function,
                // usando transações para garantir a atomicidade.
                const existingAppointmentsForRoomAndDate = allAppointments.filter(appt => 
                    appt.sala === payload.roomName && 
                    appt.data === payload.date &&
                    (appt.status === 'confirmed' || appt.status === 'Pendente') // Conflitos apenas com confirmados ou pendentes
                );

                const newStartTime = payload.startTime;
                const newEndTime = payload.endTime;

                const hasConflict = existingAppointmentsForRoomAndDate.some(appt => {
                    return !(newEndTime <= appt.inicio || newStartTime >= appt.fim);
                });

                if (hasConflict) {
                    showMessage('Conflito de agendamento! A sala já está ocupada neste horário.', 'error');
                    return; // Interrompe a execução se houver conflito
                }

                // Adiciona o novo agendamento ao Firestore
                await db.collection('agendamentos').add({
                    sala: payload.roomName,
                    data: payload.date,
                    inicio: payload.startTime,
                    fim: payload.endTime,
                    titulo: payload.title,
                    nome: payload.userName,
                    email: payload.userEmail,
                    status: 'Pendente', // Status inicial para novos agendamentos
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Timestamp gerado pelo servidor
                });
                
                showMessage('Agendamento solicitado com sucesso! Aguardando confirmação.', 'success');
                dom.appointmentForm.reset();
                // Reseta a data do formulário para hoje após o agendamento
                dom.appointmentDate.value = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0];
                await fetchAndRenderAppointments(dom.viewDatePicker.value); // Recarrega a lista de agendamentos
            } catch (error) {
                showMessage(`Erro ao agendar: ${error.message}`, 'error', 10000);
            } finally {
                dom.submitButton.disabled = false;
                dom.submitButton.innerHTML = originalButtonText;
            }
        }

        // Função para atualizar o status de um agendamento no Firestore
        async function updateAppointmentStatusInFirestore(id, newStatus) {
            try {
                // Em uma aplicação real, a autenticação e autorização de admin
                // seriam verificadas aqui (e nas Regras de Segurança do Firestore)
                await db.collection('agendamentos').doc(id).update({ status: newStatus });
                showMessage(`Status do agendamento atualizado para '${newStatus}'.`, 'success');
                await fetchAndRenderAppointments(dom.viewDatePicker.value); // Recarrega a lista
            } catch (error) {
                showMessage(`Erro ao atualizar status: ${error.message}`, 'error', 10000);
            }
        }

        // Função para excluir um agendamento do Firestore
        async function deleteAppointmentFromFirestore(id) {
            try {
                // Em uma aplicação real, a autenticação e autorização de admin
                // seriam verificadas aqui (e nas Regras de Segurança do Firestore)
                await db.collection('agendamentos').doc(id).delete();
                showMessage('Agendamento excluído com sucesso.', 'success');
                await fetchAndRenderAppointments(dom.viewDatePicker.value); // Recarrega a lista
            } catch (error) {
                showMessage(`Erro ao excluir agendamento: ${error.message}`, 'error', 10000);
            }
        }

        // --- INICIALIZAÇÃO E OUVINTES DE EVENTOS ---
        function setupEventListeners() {
            if (dom.appointmentForm) {
                dom.appointmentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const startTime = dom.startTime.value;
                    const endTime = dom.endTime.value;

                    // Validação de horário no frontend
                    if (startTime >= endTime) {
                        showMessage('A hora de início deve ser anterior à hora de término.', 'error');
                        return;
                    }

                    const payload = { 
                        roomName: dom.roomSelect.value, 
                        date: dom.appointmentDate.value, 
                        startTime: startTime, 
                        endTime: endTime, 
                        title: dom.appointmentTitle.value, 
                        userName: dom.userName.value, 
                        userEmail: dom.userEmail.value 
                    };
                    await createAppointmentInFirestore(payload);
                });
            }

            if (dom.appointmentsList) {
                dom.appointmentsList.addEventListener('click', async (e) => {
                    const button = e.target.closest('button[data-id]');
                    if (!button) return;
                    const id = button.dataset.id;
                    
                    // Verifica se o modo admin está ativado e a senha visual corresponde
                    if (currentUserRole !== 'admin' || dom.adminPassword.value !== ADMIN_PASSWORD_PLACEHOLDER) {
                        showMessage('Para ações de Admin, por favor, insira a senha de Admin e clique em OK.', 'error', 8000);
                        return;
                    }

                    if (button.classList.contains('confirm-btn')) {
                        await updateAppointmentStatusInFirestore(id, 'confirmed');
                    } else if (button.classList.contains('reject-btn')) {
                        await updateAppointmentStatusInFirestore(id, 'rejected');
                    } else if (button.classList.contains('delete-btn')) {
                        const confirmed = await customConfirm('Tem certeza que deseja excluir este agendamento? Esta ação é irreversível.');
                        if (confirmed) {
                            await deleteAppointmentFromFirestore(id);
                        }
                    }
                });
            }
            
            // Quando o usuário seleciona uma nova data no seletor de visualização
            if (dom.viewDatePicker) {
                dom.viewDatePicker.addEventListener('change', (e) => fetchAndRenderAppointments(e.target.value));
            }
            
            // Lógica para alternar entre perfil de Usuário e Admin (somente visual no frontend)
            if (dom.userRoleSelect) {
                dom.userRoleSelect.addEventListener('change', (e) => {
                    const isAdmin = e.target.value === 'admin';
                    if (dom.adminPasswordGroup) dom.adminPasswordGroup.classList.toggle('hidden', !isAdmin);
                    if (isAdmin && dom.adminPassword) dom.adminPassword.focus();
                    else {
                        currentUserRole = 'user'; // Reseta para usuário se não for admin
                        if(dom.userRoleSelect) dom.userRoleSelect.value = 'user'; // Volta a seleção para "Usuário"
                        fetchAndRenderAppointments(dom.viewDatePicker.value); // Re-renderiza para esconder botões de admin
                    }
                });
            }
            
            // Botão para "confirmar" a senha do admin (apenas para habilitar botões no frontend)
            if (dom.confirmAdminPassword) { 
                dom.confirmAdminPassword.addEventListener('click', () => {
                    // Esta validação é APENAS para fins visuais no frontend.
                    // A senha REAL para as ações de admin deve ser verificada com Firebase Security Rules e/ou Cloud Functions.
                    if (dom.adminPassword.value === ADMIN_PASSWORD_PLACEHOLDER) { 
                        currentUserRole = 'admin';
                        showMessage('Modo Administrador ativado (visual).', 'success');
                    } else {
                        currentUserRole = 'user';
                        if(dom.userRoleSelect) dom.userRoleSelect.value = 'user';
                        showMessage('Senha de Admin incorreta (somente visual).', 'error');
                    }
                    if (dom.adminPasswordGroup) dom.adminPasswordGroup.classList.add('hidden'); // Esconde o campo da senha
                    fetchAndRenderAppointments(dom.viewDatePicker.value); // Re-renderiza para mostrar/esconder botões de admin
                });
            }
        }

        function init() {
            // Define a data atual como padrão para os seletores de data
            const today = new Date(new Date().getTime() - (new Date().getTimezoneOffset() * 60000)).toISOString().split("T")[0];
            if (dom.appointmentDate) dom.appointmentDate.value = today;
            if (dom.viewDatePicker) dom.viewDatePicker.value = today;
            
            populateRoomSelect(); // Preenche o dropdown de salas
            setupEventListeners(); // Configura todos os ouvintes de eventos
            fetchAndRenderAppointments(today); // Carrega os agendamentos para o dia atual ao iniciar
        }

        init(); // Chama a função de inicialização
    </script>
</body>
</html>
